# GitHub Actions workflow for publishing the GlyphLang VS Code extension
# This workflow automatically publishes the extension to the VS Code Marketplace
# when a new version tag is pushed (e.g., v1.0.0, v2.1.3)
#
# IMPORTANT: Before this workflow can run successfully, you must add the VSCE_PAT secret:
# 1. Go to your GitHub repository Settings
# 2. Navigate to Secrets and variables > Actions
# 3. Click "New repository secret"
# 4. Name: VSCE_PAT
# 5. Value: Your Visual Studio Marketplace Personal Access Token
#
# To create a Personal Access Token (PAT):
# 1. Go to https://dev.azure.com/
# 2. Sign in with your Microsoft account
# 3. Click on your profile icon > Personal access tokens
# 4. Create a new token with "Marketplace > Manage" scope
# 5. Copy the token and add it as the VSCE_PAT secret in GitHub

name: Publish VS Code Extension

# Trigger the workflow when a tag matching the version pattern is pushed
on:
  push:
    tags:
      - 'v*.*.*'  # Matches tags like v1.0.0, v2.1.3, etc.

jobs:
  publish:
    name: Publish Extension
    runs-on: ubuntu-latest

    # Set default working directory to the vscode-extension folder
    defaults:
      run:
        working-directory: vscode-extension

    steps:
      # Step 1: Check out the repository code
      # This makes the source code available for subsequent steps
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Node.js environment
      # The extension requires Node.js for compilation and publishing
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # Use Node.js 20 LTS for stability
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      # Step 3: Install project dependencies
      # This installs all packages defined in package.json
      - name: Install dependencies
        run: npm ci  # Use 'ci' for clean, reproducible installs in CI environments

      # Step 4: Install vsce (Visual Studio Code Extension Manager)
      # vsce is the official tool for packaging and publishing VS Code extensions
      - name: Install vsce
        run: npm install -g @vscode/vsce

      # Step 5: Compile TypeScript to JavaScript
      # This runs the compile script defined in package.json
      # The vscode:prepublish script also runs compile, but we run it explicitly for clarity
      - name: Compile extension
        run: npm run compile

      # Step 6: Publish the extension to the VS Code Marketplace
      # This packages the extension and uploads it to the marketplace
      # The VSCE_PAT secret provides authentication for publishing
      - name: Publish to VS Code Marketplace
        run: vsce publish -p ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      # Step 7: Create a GitHub Release with the VSIX package (optional but recommended)
      # This creates a release artifact that users can download directly
      - name: Package extension
        run: vsce package

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: vscode-extension/*.vsix
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
